import sys
import os
import logging

# Add project root to sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "ml_engine")))

from ml_engine.exploit_generator import ExploitGenerator
from ml_engine.exploit_context import extract_vulnerability_context

# Configure logging to show INFO messages
logging.basicConfig(level=logging.INFO, format='%(levelname)s:%(name)s:%(message)s')

def get_weaponization_config():
    """Prompt user for weaponization settings"""
    print("\n" + "="*60)
    print("WEAPONIZATION CONFIGURATION")
    print("="*60)
    print("⚠️  WARNING: These features are for AUTHORIZED pentesting ONLY!")
    print("="*60 + "\n")
    
    enable = input("Enable weaponization? (y/N): ").strip().lower()
    if enable not in ['y', 'yes']:
        return False, None
    
    print("\nSelect features to enable (y/N for each):\n")
    
    config = {
        "obfuscate": False,
        "anti_debug": False,
        "anti_vm": False,
        "sandbox_evasion": False,
        "persistence": False,
        "cleanup": False,
        "bypass_aslr": False,
        "bypass_dep": False,
        "bypass_canary": False,
        "platform": "Linux",
        "architecture": "64-bit"
    }
    
    # Safe features (recommended)
    print("--- Evasion Techniques (Safe) ---")
    config["anti_debug"] = input("  Anti-debugging? (y/N): ").strip().lower() in ['y', 'yes']
    config["anti_vm"] = input("  Anti-VM detection? (y/N): ").strip().lower() in ['y', 'yes']
    config["sandbox_evasion"] = input("  Sandbox evasion? (y/N): ").strip().lower() in ['y', 'yes']
    
    print("\n--- Bypass Techniques (Safe) ---")
    config["bypass_aslr"] = input("  ASLR bypass (info leak)? (y/N): ").strip().lower() in ['y', 'yes']
    config["bypass_dep"] = input("  DEP/NX bypass (ROP)? (y/N): ").strip().lower() in ['y', 'yes']
    config["bypass_canary"] = input("  Stack canary bypass? (y/N): ").strip().lower() in ['y', 'yes']
    
    print("\n--- Obfuscation & Encoding (Safe) ---")
    config["obfuscate"] = input("  Payload obfuscation (XOR)? (y/N): ").strip().lower() in ['y', 'yes']
    
    print("\n--- ⚠️  DANGEROUS Features (Use with EXTREME caution!) ---")
    persistence_confirm = input("  Persistence mechanisms? (y/N): ").strip().lower()
    if persistence_confirm in ['y', 'yes']:
        confirm2 = input("    Are you SURE? This modifies system (y/N): ").strip().lower()
        config["persistence"] = confirm2 in ['y', 'yes']
    
    cleanup_confirm = input("  Self-deletion & cleanup? (y/N): ").strip().lower()
    if cleanup_confirm in ['y', 'yes']:
        confirm2 = input("    Are you SURE? This deletes files (y/N): ").strip().lower()
        config["cleanup"] = confirm2 in ['y', 'yes']
    
    print("\n--- Platform Configuration ---")
    platform = input("  Target platform (Linux/Windows) [Linux]: ").strip() or "Linux"
    config["platform"] = platform
    
    arch = input("  Target architecture (32-bit/64-bit) [64-bit]: ").strip() or "64-bit"
    config["architecture"] = arch
    
    print("\n" + "="*60)
    enabled_features = [k for k, v in config.items() if v is True]
    print(f"Enabled features: {', '.join(enabled_features) if enabled_features else 'None'}")
    print("="*60 + "\n")
    
    return True, config

def main():
    print("Initializing Exploit Generator... (This may take a minute to load the model)")
    try:
        generator = ExploitGenerator()
        print("\n" + "="*50)
        print("      Interactive Exploit Generator Test")
        print("="*50)
        print("Type 'exit' to quit, 'config' to change settings.\n")
        
        # Get weaponization config once at start
        weaponize, weaponize_config = get_weaponization_config()

        while True:
            vuln_desc = input("Enter Vulnerability Description: ")
            
            if vuln_desc.lower() in ['exit', 'quit']:
                break
            
            if vuln_desc.lower() == 'config':
                weaponize, weaponize_config = get_weaponization_config()
                continue
            
            if not vuln_desc.strip():
                continue

            print("\nGenerating exploit... Please wait.\n")
            try:
                # Create a mock vulnerability dict with the description
                vuln_data = {
                    "details": vuln_desc,
                    "classification": {"cwe": "Unknown"},
                    "vulnerable_chunk": ""
                }
                
                # Extract context (detects language, vuln type, etc.)
                context = extract_vulnerability_context("unknown_file", vuln_data)
                
                # Override platform/arch from weaponization config if provided
                if weaponize and weaponize_config:
                    weaponize_config["platform"] = context.platform
                    weaponize_config["architecture"] = context.architecture
                
                print(f"[Detected] Language: {context.language}, Type: {context.vulnerability_type}")
                
                # Generate enhanced exploit
                result = generator.generate_exploit_enhanced(
                    context, 
                    weaponize=weaponize, 
                    weaponize_config=weaponize_config
                )
                
                if result['success']:
                    exploit = result['script']
                    metadata = result['metadata']
                    
                    print("-" * 30)
                    print("GENERATED EXPLOIT SCRIPT:")
                    print("-" * 30)
                    print(exploit)
                    print("-" * 30)
                    print(f"\nMetadata: {metadata}")
                    print("-" * 30 + "\n")
                else:
                    print("Enhanced generation failed. Trying fallback...\n")
                    exploit = generator.generate_exploit(vuln_desc)
                    print("-" * 30)
                    print("GENERATED EXPLOIT SCRIPT (Fallback):")
                    print("-" * 30)
                    print(exploit)
                    print("-" * 30 + "\n")
                    
            except Exception as e:
                print(f"Error generating exploit: {e}")
                import traceback
                traceback.print_exc()
                print("\nTrying simple generation as fallback...")
                try:
                    exploit = generator.generate_exploit(vuln_desc)
                    print("-" * 30)
                    print("GENERATED EXPLOIT SCRIPT (Simple):")
                    print("-" * 30)
                    print(exploit)
                    print("-" * 30 + "\n")
                except Exception as e2:
                    print(f"Fallback also failed: {e2}\n")

    except Exception as e:
        print(f"Failed to initialize generator: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
