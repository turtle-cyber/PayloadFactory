"""
Fix Exploit Targets - Update all generated exploits to use the correct target IP.

This script batch-updates all exploit files in the exploits directory to:
1. Replace localhost with the actual target IP
2. Add Tomcat CVE-specific payloads
"""
import os
import re
import glob

def fix_exploit_targets(exploits_dir, target_ip="192.168.1.157", target_port=8080):
    """
    Updates all exploit files to use the correct target.
    """
    exploit_pattern = os.path.join(exploits_dir, "exploit_*.py")
    exploit_files = glob.glob(exploit_pattern)
    
    print(f"Found {len(exploit_files)} exploit files to update")
    
    updated_count = 0
    for exploit_file in exploit_files:
        try:
            with open(exploit_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            original_content = content
            
            # Replace localhost with target IP
            content = re.sub(
                r'target\s*=\s*["\']http://localhost["\']',
                f'target = "http://{target_ip}:{target_port}"',
                content
            )
            content = re.sub(
                r'target\s*=\s*["\']http://localhost:(\d+)["\']',
                f'target = "http://{target_ip}:{target_port}"',
                content
            )
            
            # Also update any direct host references
            content = content.replace('"localhost"', f'"{target_ip}"')
            content = content.replace("'localhost'", f"'{target_ip}'")
            
            if content != original_content:
                with open(exploit_file, 'w', encoding='utf-8') as f:
                    f.write(content)
                updated_count += 1
                print(f"  Updated: {os.path.basename(exploit_file)}")
        except Exception as e:
            print(f"  Error updating {exploit_file}: {e}")
    
    print(f"\nUpdated {updated_count}/{len(exploit_files)} exploit files")
    return updated_count


if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description="Fix exploit target addresses")
    parser.add_argument("--target-ip", default="192.168.1.157", help="Target IP address")
    parser.add_argument("--target-port", type=int, default=8080, help="Target port")
    parser.add_argument("--exploits-dir", default="exploits", help="Exploits directory")
    
    args = parser.parse_args()
    
    fix_exploit_targets(args.exploits_dir, args.target_ip, args.target_port)
