import os
import sys
import argparse
import logging
import subprocess

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("scan_log.txt", mode='w'), # Overwrite log on new run
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

def run_stage(script_name, args):
    """Runs a stage script as a subprocess."""
    python_exe = sys.executable
    script_path = os.path.join(os.path.dirname(__file__), script_name)
    
    cmd = [python_exe, script_path] + args
    
    logger.info(f"Launching {script_name}...")
    try:
        # We use check_call to wait for completion and check exit code
        subprocess.check_call(cmd)
        logger.info(f"{script_name} completed successfully.")
    except subprocess.CalledProcessError as e:
        logger.error(f"{script_name} failed with exit code {e.returncode}.")
        sys.exit(e.returncode)

def main():
    parser = argparse.ArgumentParser(description="PayloadFactoryUX - Folder Scan & Exploit")
    parser.add_argument("target_dir", help="Path to the directory to scan")
    parser.add_argument("--output", default="exploits", help="Directory to save generated exploits")
    parser.add_argument("--remote-host", help="Target IP for active exploitation (Stage 3)")
    parser.add_argument("--remote-port", type=int, help="Target Port for active exploitation (Stage 3)")
    
    args = parser.parse_args()
    
    intermediate_file = os.path.join(os.path.dirname(__file__), "intermediate_findings.json")
    
    # --- STAGE 1: C/C++ SCAN ---
    run_stage("scan_stage_1.py", [args.target_dir, intermediate_file])
    
    # --- STAGE 2: LLM SCAN & EXPLOIT ---
    stage2_args = [args.target_dir, args.output, intermediate_file]
    if args.remote_host and args.remote_port:
        stage2_args.extend(["--remote-host", args.remote_host, "--remote-port", str(args.remote_port)])
    run_stage("scan_stage_2.py", stage2_args)
    
    # --- STAGE 3: FUZZING & RL (ATTACK MODE) ---
    stage3_args = [args.output]
    if args.remote_host and args.remote_port:
        stage3_args.extend(["--remote-host", args.remote_host, "--remote-port", str(args.remote_port)])
        
    run_stage("scan_stage_3.py", stage3_args)
    
    # Cleanup
    if os.path.exists(intermediate_file):
        try:
            os.remove(intermediate_file)
        except:
            pass

    logger.info("ALL STAGES COMPLETED SUCCESSFULLY.")

if __name__ == "__main__":
    main()
